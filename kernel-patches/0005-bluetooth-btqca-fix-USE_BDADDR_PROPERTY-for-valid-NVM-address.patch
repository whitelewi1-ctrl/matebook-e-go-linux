From: Lewis White <whitelewis@gaokun3>
Date: Sat, 8 Feb 2026
Subject: [PATCH] Bluetooth: btqca: only set USE_BDADDR_PROPERTY when address
 is all-zero

qca_check_bdaddr() currently sets HCI_QUIRK_USE_BDADDR_PROPERTY whenever
the controller's BD address matches the address stored in the NVM firmware
file. This causes the HCI stack to expect a 'local-bd-address' device tree
property to provide the real address.

On the Huawei MateBook E Go (WCN6855), the NVM firmware ships with a
partially invalid BD address (ad:5a:00:00:00:00). After patching the NVM
file with a valid locally-administered address, the controller correctly
reports that address. However, qca_check_bdaddr() still sets the quirk
because the controller address matches the (now valid) NVM address, causing
the controller to remain in HCI_UNCONFIGURED state when no device tree
property exists.

Change the check to only set the quirk when the controller reports
BDADDR_ANY (all zeros), which unambiguously indicates an invalid address
that must be provided externally.

Signed-off-by: Lewis White <whitelewis@gaokun3>
---
 drivers/bluetooth/btqca.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/bluetooth/btqca.c b/drivers/bluetooth/btqca.c
index abcdef123..1234567ab 100644
--- a/drivers/bluetooth/btqca.c
+++ b/drivers/bluetooth/btqca.c
@@ -738,7 +738,7 @@ static int qca_check_bdaddr(struct hci_dev *hdev, const struct qca_fw_config *co
 	}

 	bda = (struct hci_rp_read_bd_addr *)skb->data;
-	if (!bacmp(&bda->bdaddr, &config->bdaddr))
+	if (!bacmp(&bda->bdaddr, BDADDR_ANY))
 		hci_set_quirk(hdev, HCI_QUIRK_USE_BDADDR_PROPERTY);

 	kfree_skb(skb);
